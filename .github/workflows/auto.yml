# Clash 规则自动更新工作流

name: Auto Update Rules

on:
  # 每天 UTC 00:00 自动运行
  schedule:
    - cron: '0 0 * * *'
  
  # 允许手动触发
  workflow_dispatch:
  
  # 推送到 main 分支时也运行（可选，用于测试）
  push:
    branches: [ "main" ]
    paths:
      - 'config.toml'
      - 'src/**'
      - 'Cargo.toml'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 设置 Rust 环境
      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      # 缓存 Cargo 依赖
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # 编译程序
      - name: Build
        run: cargo build --release

      # 运行规则更新
      - name: Run ruletool
        run: ./target/release/ruletool config.toml

      # 提交更新的规则文件
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto update rules $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi

